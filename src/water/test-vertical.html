<html>
<head title="test-vertical">
    <script>
      window.onload = function() {
        const iframe = document.getElementById('iframe');
        const frameWindow = iframe.contentWindow;
        const topOffset = 25;
        const startButton = document.getElementById('start');
        const validateButton = document.getElementById('validate');
        const screenHeight = window.innerHeight|| document.documentElement.clientHeight|| document.body.clientHeight;
        const width = screenHeight * 9 / 16;

        if (frameWindow && frameWindow.document) {
          function resetIframe() {
            if (!!window.chrome) {
              frameWindow.document.open();
              frameWindow.document.write('');
              frameWindow.document.close();
            }
            frameWindow.location.reload();
          }
          function play(reset = true) {
            reset && resetIframe();
            setTimeout(() =>  frameWindow.document.dispatchEvent(new CustomEvent('test')), 500)
          }
          if (window.location.hash && window.location.hash === '#fullscreen') {
            controls.classList.add('d-none');
            iframe.style.height = screenHeight + 'px';
            iframe.style.width = width + 'px';
            play(false)
          } else {
            iframe.style.height = screenHeight - topOffset + 'px';
            iframe.style.width = width + 'px';
          }
          startButton.addEventListener('click', play);
          validateButton.addEventListener('click', function () {
            const invalidTimeout = setTimeout(() => alert('INVALID!\nNo response / no play started'), 1000);
            function showResult(message) {
              clearTimeout(invalidTimeout);
              alert(message);
              resetIframe();
            }
            frameWindow.onerror = function () {
              showResult('INVALID!\nErrors in container script.\nCheck browser console.');
            }
            if (!frameWindow.webContainer) return showResult('INVALID!\nNo container instance found.');
            if (!frameWindow.webContainer.data) return showResult('INVALID!\nNo key-value storage found.');
            if (!frameWindow.webContainer.testData) return showResult('INVALID!\nNo test data found.');
            ['init', 'setup', 'play'].forEach(
              (method) => !frameWindow.webContainer[method] && showResult('INVALID\nNo "' + method + '" method found in container instance.')
            );
            const setupEvent = new CustomEvent('setup', {
              detail: Object.assign({ abc: 123 }, frameWindow.webContainer.testData)
            });
            frameWindow.document.addEventListener('ptvready', function () {
              frameWindow.document.dispatchEvent(new CustomEvent('play'))
            })
            frameWindow.document.addEventListener('playStarted', function () {
              const value = frameWindow.webContainer.data.abc;
              const message = !value || value !== 123 ? 'INVALID!\nKey-value passing doesn\'t work.' : 'VALID';
              showResult(message);
            })
            frameWindow.document.dispatchEvent(setupEvent);
          });
        }
      };
    </script>
    <style>
        * { box-sizing: border-box; }
        iframe { border: none!important; }
        body { margin: 0; display: flex; justify-content: center; }
        .wrapper { display: flex; flex-direction: column; height: 100%; }
        .actions { display: flex; height: 25px }
        .actions button { width: 100% }
        .d-none { display: none }
    </style>
</head>
<body>
<div class="wrapper">
    <div id="controls" class="actions">
        <button id="start">Play</button>
        <button id="validate">Validate</button>
    </div>
    <iframe id="iframe" title="Test" src="index.html">
    </iframe>
</div>
</body>
</html>
